<?xml version="1.0"?>
<Workflow
  subtype="MetroReportWorkflow"
  version="1"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="workflow.xsd">
  <Context>
    <Symbol
      name="metroReport"
      type="MetroReport"
      value="Workflow.MetroReport"/>
    <Symbol
      name="claim"
      type="Claim"
      value="Workflow.Claim"/>
  </Context>
  <Start
    firstStep="SendOrder"/>
  <!-- ================================ SENDING ORDER =================================== -->
  <AutoStep
    id="SendOrder"
    layoutid="10041114">
    <Assert
      condition="metroReport.Status == TC_VALIDATED"
      message="MetroReport must be validated at start of Workflow"/>
    <Enter><![CDATA[// Sends the "MetroReportOrderFile" message in Event rules
      metroReport.Status = TC_SENDINGORDER]]></Enter>
    <Go
      desc=""
      layoutid="10855753"
      nextStep="CheckOnOrder"/>
  </AutoStep>
  <AutoStep
    id="CheckOnOrder"
    layoutid="22214031">
    <Go
      desc=""
      id="accepted"
      if="metroReport.Status == TC_ACCEPTED or metroReport.Status == TC_PENDING"
      layoutid="31025082"
      nextStep="WaitBeforeInquiry"/>
    <Go
      desc=""
      id="orderfailed"
      if="metroReport.Status == TC_ORDERFAILED"
      layoutid="2687752"
      nextStep="SendFailed"/>
    <Go
      desc=""
      id="error"
      if="metroReport.Status == TC_ERROR"
      layoutid="8790553"
      nextStep="SendFailed"/>
    <Go
      desc=""
      id="orderTimedOut"
      if="metroReport.PastOrderTimeout"
      layoutid="13598146"
      nextStep="OrderTimedOut"/>
    <Go
      desc=""
      id="duplicateWithReport"
      if="metroReport.Status == TC_HASREPORT"
      layoutid="3899905"
      nextStep="DownloadReport"/>
    <Go
      desc=""
      layoutid="2675737"
      nextStep="RetryCheckOnOrder"/>
  </AutoStep>
  <ManualStep
    id="RetryCheckOnOrder"
    layoutid="24612435">
    <Timeout
      desc=""
      layoutid="8185505"
      nextStep="CheckOnOrder"
      timeDelta="5m"/>
  </ManualStep>
  <!-- ================================ WAITING BEFORE INQUIRY =================================== -->
  <ManualStep
    id="WaitBeforeInquiry"
    layoutid="2163844">
    <Timeout
      desc=""
      layoutid="614550"
      nextStep="SendInquiry"
      timeAbsolute="gw.api.util.DateUtil.addMinutes(Workflow.EnteredStep, gw.api.upgrade.Coercions.makePIntFrom(metroReport.InquiryWaitInterval))"/>
  </ManualStep>
  <!-- ================================ SENDING INQUIRY =================================== -->
  <AutoStep
    id="SendInquiry"
    layoutid="28280470">
    <Enter><![CDATA[// Sends the "MetroReportOrderInquiryFile" message in Event rules
      metroReport.Status = TC_SENDINGINQUIRY]]></Enter>
    <Go
      desc=""
      layoutid="27537533"
      nextStep="CheckOnInquiry"/>
  </AutoStep>
  <AutoStep
    id="CheckOnInquiry"
    layoutid="11341523">
    <Go
      desc=""
      id="pending"
      if="metroReport.Status == TC_PENDING"
      layoutid="7043860"
      nextStep="WaitBeforeInquiry"/>
    <Go
      desc=""
      id="hasReport"
      if="metroReport.Status == TC_HASREPORT"
      layoutid="6135260"
      nextStep="DownloadReport"/>
    <Go
      desc=""
      id="holdWithActivity"
      if="metroReport.Status == TC_HOLD and metroReport.CreateHoldActivity"
      layoutid="2560563"
      nextStep="InquiryHeldActivity"/>
    <Go
      desc=""
      id="holdWithoutActivity"
      if="metroReport.Status == TC_HOLD and !metroReport.CreateHoldActivity"
      layoutid="18606577"
      nextStep="WaitBeforeInquiry"/>
    <Go
      desc=""
      id="deferredWithActivity"
      if="metroReport.Status == TC_DEFERRED and metroReport.CreateDeferredActivity"
      layoutid="26988764"
      nextStep="InquiryDeferredActivity"/>
    <Go
      desc=""
      id="deferredWithoutActivity"
      if="metroReport.Status == TC_DEFERRED and !metroReport.CreateDeferredActivity"
      layoutid="11352336"
      nextStep="WaitBeforeInquiry"/>
    <Go
      desc=""
      id="inquiryFailed"
      if="metroReport.Status == TC_INQUIRYFAILED"
      layoutid="8215615"
      nextStep="InquiryFailedActivity"/>
    <Go
      desc=""
      id="closed"
      if="metroReport.Status == TC_CLOSED &amp;&amp; metroReport.DocumentURL == null"
      layoutid="3367344"
      nextStep="OrderClosed"/>
    <Go
      desc=""
      id="closedWithReport"
      if="metroReport.Status == TC_CLOSED &amp;&amp; metroReport.DocumentURL != null"
      layoutid="30270834"
      nextStep="DownloadClosedReport"/>
    <Go
      desc=""
      id="error"
      if="metroReport.Status == TC_ERROR"
      layoutid="22194826"
      nextStep="WaitBeforeInquiry"/>
    <Go
      desc=""
      id="workflowTimedOut"
      if="metroReport.PastWorkflowTimeout"
      layoutid="24442476"
      nextStep="WorkflowTimedOut"/>
    <Go
      desc=""
      layoutid="3832554"
      nextStep="RetryCheckOnInquiry"/>
  </AutoStep>
  <ManualStep
    id="RetryCheckOnInquiry"
    layoutid="27812318">
    <Timeout
      desc=""
      layoutid="22785877"
      nextStep="CheckOnInquiry"
      timeDelta="5m"/>
  </ManualStep>
  <!-- ================================ HANDLING THE INQUIRY =================================== -->
  <AutoStep
    id="InquiryHeldActivity"
    layoutid="28398961">
    <Notification
      pattern="metropolitan_report_held">
      <Init><![CDATA[Workflow.initActivity(Activity);
        Activity.Description =
          gw.api.locale.DisplayKey.get("Workflow.MetroReport.InquiryHeldActivity", metroReport.MetroReportType, claim.ClaimNumber, metroReport.ErrorMessage, metroReport.InformationURL);
        Activity.assignToClaimOwner();]]></Init>
    </Notification>
    <Go
      desc=""
      layoutid="5509066"
      nextStep="WaitBeforeInquiry"/>
  </AutoStep>
  <AutoStep
    id="InquiryDeferredActivity"
    layoutid="23112737">
    <Notification
      pattern="metropolitan_report_deferred">
      <Init><![CDATA[Workflow.initActivity(Activity);
        Activity.Description =
          gw.api.locale.DisplayKey.get("Workflow.MetroReport.InquiryDeferredActivity", metroReport.MetroReportType, claim.ClaimNumber, metroReport.ErrorMessage, metroReport.DelayMemoURL);
        Activity.assignToClaimOwner();]]></Init>
    </Notification>
    <Go
      desc=""
      layoutid="14203871"
      nextStep="WaitBeforeInquiry"/>
  </AutoStep>
  <AutoStep
    id="DownloadReport"
    layoutid="29679763">
    <Enter><![CDATA[libraries.Metro.downloadHasReportDocument( metroReport )]]></Enter>
    <Go
      desc=""
      layoutid="18231547"
      nextStep="CheckHasReportDocumentReady"/>
  </AutoStep>
  <ManualStep
    id="RetryCheckHasReportDocumentReady"
    layoutid="7600315">
    <Timeout
      desc=""
      layoutid="32108524"
      nextStep="CheckHasReportDocumentReady"
      timeDelta="5m"/>
  </ManualStep>
  <AutoStep
    id="CheckHasReportDocumentReady"
    layoutid="30329749">
    <Go
      desc=""
      id="hasReportDocumentReady"
      if="metroReport.Status == TC_RECEIVED"
      layoutid="25588745"
      nextStep="ReportFinished"/>
    <Go
      desc=""
      id="hasReportDocumentError"
      if="metroReport.Status == TC_ERROR"
      layoutid="2894551"
      nextStep="WaitBeforeInquiry"/>
    <Go
      desc=""
      id="workflowTimedOut"
      if="metroReport.PastWorkflowTimeout"
      layoutid="24375328"
      nextStep="WorkflowTimedOut"/>
    <Go
      desc=""
      layoutid="28351701"
      nextStep="RetryCheckHasReportDocumentReady"/>
  </AutoStep>
  <!-- ================================ OUTCOMES =================================== -->
  <Outcome
    desc=""
    id="SendFailed"
    layoutid="26715168">
    <Notification
      pattern="metropolitan_request_failed">
      <Init><![CDATA[Workflow.initActivity(Activity);
        Activity.Description =
          gw.api.locale.DisplayKey.get("Workflow.MetroReport.SendOrderFailed", metroReport.MetroReportType, claim.ClaimNumber, metroReport.ErrorMessage);
        Activity.assignToClaimOwner();]]></Init>
    </Notification>
  </Outcome>
  <Outcome
    id="OrderClosed"
    layoutid="9980233">
    <Notification
      pattern="metropolitan_report_unavailable">
      <Init><![CDATA[Workflow.initActivity(Activity);
        Activity.Description = Activity.Description + " " +
          gw.api.locale.DisplayKey.get("Workflow.MetroReport.SendOrderFailed", metroReport.MetroReportType, claim.ClaimNumber, metroReport.ErrorMessage);
        Activity.assignToClaimOwner();]]></Init>
    </Notification>
  </Outcome>
  <Outcome
    id="ReportFinished"
    layoutid="32726548">
    <Notification
      pattern="metropolitan_report_available">
      <Init><![CDATA[Workflow.initActivity(Activity);
        Activity.Description = gw.api.locale.DisplayKey.get("Workflow.MetroReport.ReportFinished", metroReport.MetroReportType, claim.ClaimNumber, metroReport.CreateTime);
        Activity.assignToClaimOwner();]]></Init>
    </Notification>
  </Outcome>
  <AutoStep
    id="DownloadClosedReport"
    layoutid="18611714">
    <Enter><![CDATA[libraries.Metro.downloadClosedDocument( metroReport )]]></Enter>
    <Go
      desc=""
      id="OrderClosed"
      layoutid="3530991"
      nextStep="OrderClosed"/>
  </AutoStep>
  <AutoStep
    id="InquiryFailedActivity"
    layoutid="2061073">
    <Notification
      pattern="metropolitan_report_inquiry_failed">
      <Init><![CDATA[Workflow.initActivity(Activity);
Activity.Description =
  gw.api.locale.DisplayKey.get("Workflow.MetroReport.InquiryFailedActivity", metroReport.MetroReportType, claim.ClaimNumber, metroReport.ErrorMessage, metroReport.DelayMemoURL);
Activity.assignToClaimOwner();]]></Init>
    </Notification>
    <Go
      desc=""
      id="WaitBeforeInquiry"
      layoutid="8306609"
      nextStep="WaitBeforeInquiry"/>
  </AutoStep>
  <Outcome
    desc="Outcome if our initial order request does not get a response from Metro in a reasonable amount of time"
    id="OrderTimedOut"
    layoutid="15955969">
    <Notification
      pattern="metropolitan_request_failed">
      <Init><![CDATA[Workflow.initActivity(Activity)
Activity.Description = gw.api.locale.DisplayKey.get("Workflow.MetroReport.SendOrderTimedOut", metroReport.MetroReportType, claim.ClaimNumber);
Activity.assignToClaimOwner();]]></Init>
    </Notification>
  </Outcome>
  <Outcome
    desc="Outcome if entire workflow has been running too long and should be shut down"
    id="WorkflowTimedOut"
    layoutid="32339600">
    <Notification
      pattern="metropolitan_request_failed">
      <Init><![CDATA[Workflow.initActivity(Activity)
Activity.Description = gw.api.locale.DisplayKey.get("Workflow.MetroReport.WorkflowTimedOut", metroReport.MetroReportType, claim.ClaimNumber);
Activity.assignToClaimOwner();]]></Init>
    </Notification>
  </Outcome>
  <Layout>
    <BoxUI
      height="4"
      layoutid="10041114"
      width="10"
      x="34"
      y="-68"/>
    <BoxUI
      height="4"
      layoutid="22214031"
      width="12"
      x="33"
      y="-58"/>
    <BoxUI
      height="4"
      layoutid="24612435"
      width="15"
      x="10"
      y="-46"/>
    <BoxUI
      height="4"
      layoutid="2163844"
      width="20"
      x="28"
      y="-31"/>
    <BoxUI
      height="4"
      layoutid="28280470"
      width="11"
      x="60"
      y="-26"/>
    <BoxUI
      height="4"
      layoutid="11341523"
      width="13"
      x="35"
      y="-15"/>
    <BoxUI
      height="4"
      layoutid="27812318"
      width="17"
      x="65"
      y="-15"/>
    <BoxUI
      height="4"
      layoutid="28398961"
      width="18"
      x="-11"
      y="-9"/>
    <BoxUI
      height="4"
      layoutid="23112737"
      width="18"
      x="1"
      y="-16"/>
    <BoxUI
      height="4"
      layoutid="29679763"
      width="14"
      x="60"
      y="-9"/>
    <BoxUI
      height="4"
      layoutid="7600315"
      width="20"
      x="83"
      y="4"/>
    <BoxUI
      height="4"
      layoutid="30329749"
      width="20"
      x="77"
      y="-4"/>
    <BoxUI
      height="4"
      layoutid="26715168"
      width="9"
      x="58"
      y="-45"/>
    <BoxUI
      height="5"
      layoutid="9980233"
      width="11"
      x="38"
      y="-5"/>
    <BoxUI
      height="4"
      layoutid="32726548"
      width="14"
      x="73"
      y="10"/>
    <ArrowUI
      layoutid="10855753"
      visible="true">
      <PointUI
        x="39"
        y="-64"/>
      <PointUI
        x="39"
        y="-58"/>
    </ArrowUI>
    <ArrowUI
      layoutid="31025082"
      visible="true">
      <PointUI
        x="38"
        y="-54"/>
      <PointUI
        x="38"
        y="-31"/>
    </ArrowUI>
    <ArrowUI
      layoutid="2687752"
      visible="true">
      <PointUI
        x="42"
        y="-54"/>
      <PointUI
        x="42"
        y="-49"/>
      <PointUI
        x="64"
        y="-49"/>
      <PointUI
        x="64"
        y="-45"/>
    </ArrowUI>
    <ArrowUI
      layoutid="8790553"
      visible="true">
      <PointUI
        x="40"
        y="-54"/>
      <PointUI
        x="40"
        y="-47"/>
      <PointUI
        x="61"
        y="-47"/>
      <PointUI
        x="61"
        y="-45"/>
    </ArrowUI>
    <ArrowUI
      layoutid="2675737"
      visible="true">
      <PointUI
        x="36"
        y="-54"/>
      <PointUI
        x="36"
        y="-50"/>
      <PointUI
        x="17"
        y="-50"/>
      <PointUI
        x="17"
        y="-46"/>
    </ArrowUI>
    <ArrowUI
      layoutid="8185505"
      visible="true">
      <PointUI
        x="17"
        y="-42"/>
      <PointUI
        x="17"
        y="-38"/>
      <PointUI
        x="4"
        y="-38"/>
      <PointUI
        x="4"
        y="-61"/>
      <PointUI
        x="37"
        y="-61"/>
      <PointUI
        x="37"
        y="-58"/>
    </ArrowUI>
    <ArrowUI
      layoutid="614550"
      visible="true">
      <PointUI
        x="48"
        y="-29"/>
      <PointUI
        x="66"
        y="-29"/>
      <PointUI
        x="66"
        y="-26"/>
    </ArrowUI>
    <ArrowUI
      layoutid="27537533"
      visible="true">
      <PointUI
        x="66"
        y="-22"/>
      <PointUI
        x="66"
        y="-18"/>
      <PointUI
        x="47"
        y="-18"/>
      <PointUI
        x="47"
        y="-15"/>
    </ArrowUI>
    <ArrowUI
      layoutid="7043860"
      visible="true">
      <PointUI
        x="42"
        y="-15"/>
      <PointUI
        x="42"
        y="-27"/>
    </ArrowUI>
    <ArrowUI
      layoutid="6135260"
      visible="true">
      <PointUI
        x="47"
        y="-11"/>
      <PointUI
        x="47"
        y="-7"/>
      <PointUI
        x="60"
        y="-7"/>
    </ArrowUI>
    <ArrowUI
      layoutid="2560563"
      visible="true">
      <PointUI
        x="35"
        y="-12"/>
      <PointUI
        x="26"
        y="-12"/>
      <PointUI
        x="26"
        y="-7"/>
      <PointUI
        x="7"
        y="-7"/>
    </ArrowUI>
    <ArrowUI
      layoutid="18606577"
      visible="true">
      <PointUI
        x="38"
        y="-15"/>
      <PointUI
        x="38"
        y="-27"/>
    </ArrowUI>
    <ArrowUI
      layoutid="26988764"
      visible="true">
      <PointUI
        x="35"
        y="-14"/>
      <PointUI
        x="19"
        y="-14"/>
    </ArrowUI>
    <ArrowUI
      layoutid="11352336"
      visible="true">
      <PointUI
        x="40"
        y="-15"/>
      <PointUI
        x="40"
        y="-27"/>
    </ArrowUI>
    <ArrowUI
      layoutid="8215615"
      visible="true">
      <PointUI
        x="36"
        y="-15"/>
      <PointUI
        x="36"
        y="-20"/>
      <PointUI
        x="30"
        y="-20"/>
    </ArrowUI>
    <ArrowUI
      layoutid="3367344"
      visible="true">
      <PointUI
        x="43"
        y="-11"/>
      <PointUI
        x="43"
        y="-5"/>
    </ArrowUI>
    <ArrowUI
      layoutid="22194826"
      visible="true">
      <PointUI
        x="44"
        y="-15"/>
      <PointUI
        x="44"
        y="-27"/>
    </ArrowUI>
    <ArrowUI
      layoutid="3832554"
      visible="true">
      <PointUI
        x="48"
        y="-14"/>
      <PointUI
        x="65"
        y="-14"/>
    </ArrowUI>
    <ArrowUI
      layoutid="22785877"
      visible="true">
      <PointUI
        x="65"
        y="-12"/>
      <PointUI
        x="48"
        y="-12"/>
    </ArrowUI>
    <ArrowUI
      layoutid="5509066"
      visible="true">
      <PointUI
        x="-2"
        y="-9"/>
      <PointUI
        x="-2"
        y="-37"/>
      <PointUI
        x="35"
        y="-37"/>
      <PointUI
        x="35"
        y="-31"/>
    </ArrowUI>
    <ArrowUI
      layoutid="14203871"
      visible="true">
      <PointUI
        x="9"
        y="-16"/>
      <PointUI
        x="9"
        y="-34"/>
      <PointUI
        x="32"
        y="-34"/>
      <PointUI
        x="32"
        y="-31"/>
    </ArrowUI>
    <ArrowUI
      layoutid="18231547"
      visible="true">
      <PointUI
        x="74"
        y="-7"/>
      <PointUI
        x="85"
        y="-7"/>
      <PointUI
        x="85"
        y="-4"/>
    </ArrowUI>
    <ArrowUI
      layoutid="32108524"
      visible="true">
      <PointUI
        x="93"
        y="4"/>
      <PointUI
        x="93"
        y="0"/>
    </ArrowUI>
    <ArrowUI
      layoutid="25588745"
      visible="true">
      <PointUI
        x="81"
        y="0"/>
      <PointUI
        x="81"
        y="10"/>
    </ArrowUI>
    <ArrowUI
      layoutid="2894551"
      visible="true">
      <PointUI
        x="88"
        y="-4"/>
      <PointUI
        x="88"
        y="-34"/>
      <PointUI
        x="41"
        y="-34"/>
      <PointUI
        x="41"
        y="-31"/>
    </ArrowUI>
    <ArrowUI
      layoutid="28351701"
      visible="true">
      <PointUI
        x="88"
        y="0"/>
      <PointUI
        x="88"
        y="4"/>
    </ArrowUI>
    <BoxUI
      height="4"
      layoutid="18611714"
      width="20"
      x="33"
      y="4"/>
    <ArrowUI
      layoutid="3530991"
      visible="true">
      <PointUI
        x="43"
        y="4"/>
      <PointUI
        x="43"
        y="0"/>
    </ArrowUI>
    <ArrowUI
      layoutid="30270834"
      visible="true">
      <PointUI
        x="37"
        y="-11"/>
      <PointUI
        x="37"
        y="4"/>
    </ArrowUI>
    <BoxUI
      height="4"
      layoutid="19899359"
      width="8"
      x="1"
      y="18"/>
    <BoxUI
      height="4"
      layoutid="2061073"
      width="18"
      x="12"
      y="-22"/>
    <ArrowUI
      layoutid="8306609"
      visible="true">
      <PointUI
        x="29"
        y="-22"/>
      <PointUI
        x="29"
        y="-27"/>
    </ArrowUI>
    <BoxUI
      height="4"
      layoutid="15955969"
      width="10"
      x="69"
      y="-45"/>
    <ArrowUI
      layoutid="13598146"
      visible="true">
      <PointUI
        x="44"
        y="-54"/>
      <PointUI
        x="44"
        y="-51"/>
      <PointUI
        x="74"
        y="-51"/>
      <PointUI
        x="74"
        y="-45"/>
    </ArrowUI>
    <BoxUI
      height="4"
      layoutid="32339600"
      width="10"
      x="54"
      y="10"/>
    <ArrowUI
      layoutid="24442476"
      visible="true">
      <PointUI
        x="45"
        y="-11"/>
      <PointUI
        x="45"
        y="-6"/>
      <PointUI
        x="58"
        y="-6"/>
      <PointUI
        x="58"
        y="10"/>
    </ArrowUI>
    <ArrowUI
      layoutid="24375328"
      visible="true">
      <PointUI
        x="79"
        y="0"/>
      <PointUI
        x="79"
        y="5"/>
      <PointUI
        x="60"
        y="5"/>
      <PointUI
        x="60"
        y="10"/>
    </ArrowUI>
    <ArrowUI
      layoutid="3899905"
      visible="true">
      <PointUI
        x="45"
        y="-56"/>
      <PointUI
        x="91"
        y="-56"/>
      <PointUI
        x="91"
        y="-8"/>
      <PointUI
        x="74"
        y="-8"/>
    </ArrowUI>
  </Layout>
  <![CDATA[

  Orde














]]>
</Workflow>